#!/bin/sh

# Unofficial shell script to update the installed version of Go.
# Copyright (C) 2026  Spenser Black
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
BASE_DIR="$(dirname "$(dirname "$(readlink -f "$0")")")"
GO_HOST="go.dev"
GO_DL_URL="$GO_HOST/dl/"
GO_PATH="/usr/local/go"
usage="goup [OPTIONS] [SUBCOMMAND]
Unofficial tool to update go

OPTIONS:
	-h, --help	Show this help text and exit

SUBCOMMANDS:
	check		Compare the currently installed version to the latest available
	update		Update to the latest version
	help		Show this help text and exit
"

# Asks a user for confirmation. Exits on a "no" answer.
# Arguments:
# 1. message (excluding choices)
# 2. default
confirm() {
	case "$2" in
		y|Y)
			yes=Y
			no=n
			default=y
			;;
		n|N)
			yes=y
			no=N
			default=n
			;;
		*)
			echo "unreachable" >&2
			exit 1
			;;
		esac
	printf "%s [%s/%s] " "$1" "$yes" "$no"
	read -r choice
	if [ "$choice" = "" ]; then
		choice="$default"
	fi
	case "$choice" in
		y|Y)
			;;
		n|N)
			exit 0
			;;
		*)
			echo "invalid choice"
			confirm "$1" "$2"
	esac
}

get_latest_release() {
	URL="$GO_DL_URL?mode=json"
	latest_release="$(curl -fsS "https://$URL" | jq -r '.[0].version')"
}

get_installed_release() {
	installed_release="$(go version | awk -f "$BASE_DIR/share/goup/go-version.awk" -- "$GO_PATH/VERSION")"
}

# Downloads and installs the latest release.
# Arguments:
# 1. The go version. For example `go1.25`.
download_and_install() {
	case "$(uname -s)" in
		Linux)
			os="linux"
			;;
		*)
			echo "Unsupported kernel: $(uname -s)" >&2
			exit 1
			;;
	esac
	case "$(uname -m)" in
		x86_64)
			arch="amd64"
			;;
		*)
			echo "Unsupported architecture: $(uname -m)" >&2
			exit 1
			;;
	esac
	full_version="$1.$os-$arch"
	echo "Installing $full_version"
	confirm "This script will ask for sudo access and modify the contents under /usr/local/. Is that okay?" "N"
	echo "Deleting $GO_PATH"
	sudo rm -rf "$GO_PATH"
	url="$GO_DL_URL$full_version.tar.gz"
	echo "Fetching and installing $url"
	curl -fsSL "https://$url" | sudo tar -C /usr/local -xzf -

}

check() {
	get_installed_release
	get_latest_release
	echo "Current version: $installed_release"
	echo "Latest available version: $latest_release"

	if [ "$installed_release" = "$latest_release" ]; then
		echo "Your version is up to date"
	elif [ "$(expr "$installed_release" \< "$latest_release" )" = 1 ]; then
		echo "A newer version is available"
	else
		echo "You have a version installed that is higher than the latest release"
	fi
}

update() {
	get_installed_release
	get_latest_release

	if [ "$installed_release" = "$latest_release" ]; then
		echo "Your version is up to date"
		exit 0
	elif [ "$(expr "$installed_release" \< "$latest_release" )" = 1 ]; then
		download_and_install "$latest_release"
		exit 0
	else
		echo "You have a version installed that is higher than the latest release"
		exit 0
	fi
}

help() {
	printf "%s" "$usage"
}

case "$1" in
	-h|--help|help)
		help
		;;
	check)
		check
		;;
	update)
		update
		;;
	*)
		help >&2
		exit 1
esac
